

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Coordination &mdash; nucleus7 v0.10.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/icon.ico"/>
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Optimization" href="Optimization.html" />
    <link rel="prev" title="Model parts" href="Model.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> nucleus7
          

          
            
            <img src="_static/icon.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.10.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Project.html">Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="Core.html">Nucleotide and co.</a></li>
<li class="toctree-l1"><a class="reference internal" href="DataHandling.html">Data handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Model.html">Model parts</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Coordination</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#coordinatorcallback-a-name-callback-a">CoordinatorCallback <span class="raw-html-m2r"><a name="callback"></a></span></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#interruption-of-data-flow-a-name-interruption-of-data-flow-a">Interruption of data flow <span class="raw-html-m2r"><a name="interruption-of-data-flow"></a></span></a></li>
<li class="toctree-l3"><a class="reference internal" href="#saver-callback-a-name-saver-callback-a">Saver callback <span class="raw-html-m2r"><a name="saver-callback"></a></span></a></li>
<li class="toctree-l3"><a class="reference internal" href="#buffer-callback-a-name-buffer-callback-a">Buffer callback <span class="raw-html-m2r"><a name="buffer-callback"></a></span></a></li>
<li class="toctree-l3"><a class="reference internal" href="#callbacks-as-sessionrunhook-a-name-callback-training-a">Callbacks as SessionRunHook <span class="raw-html-m2r"><a name="callback_training"></a></span></a></li>
<li class="toctree-l3"><a class="reference internal" href="#kpievaluator-as-callback-a-name-kpi-callback-a">KPIEvaluator as callback <span class="raw-html-m2r"><a name="kpi-callback"></a></span></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#callbackshandler-a-name-callbacks-handler-a">CallbacksHandler <span class="raw-html-m2r"><a name="callbacks-handler"></a></span></a></li>
<li class="toctree-l2"><a class="reference internal" href="#trainer-a-name-trainer-a">Trainer <span class="raw-html-m2r"><a name="trainer"></a></span></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-of-estimator-api-a-name-using-of-estimator-api-a">Using of estimator API <span class="raw-html-m2r"><a name="using-of-estimator-API"></a></span></a></li>
<li class="toctree-l3"><a class="reference internal" href="#export-of-the-model-a-name-model-export-a">Export of the model <span class="raw-html-m2r"><a name="model-export"></a></span></a></li>
<li class="toctree-l3"><a class="reference internal" href="#profiling-a-name-profiling-a">Profiling <span class="raw-html-m2r"><a name="profiling"></a></span></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#inferer-a-name-inferer-a">Inferer <span class="raw-html-m2r"><a name="inferer"></a></span></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tensorrt-support-a-name-tensorrt-support-a">Tensorrt support <span class="raw-html-m2r"><a name="tensorrt-support"></a></span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Optimization.html">Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="KPI.html">KPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="Development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contribution.html">Contribution</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.builders.html">nucleus7.builders package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.coordinator.html">nucleus7.coordinator package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.core.html">nucleus7.core package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.data.html">nucleus7.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.kpi.html">nucleus7.kpi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.model.html">nucleus7.model package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.optimization.html">nucleus7.optimization package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.test_utils.html">nucleus7.test_utils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.third_party.html">nucleus7.third_party package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/nucleus7.utils.html">nucleus7.utils package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">nucleus7</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Coordination</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Coordination.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="coordination">
<h1>Coordination<a class="headerlink" href="#coordination" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#coordinatorcallback-a-name-callback-a" id="id1">CoordinatorCallback <span class="raw-html-m2r"><a name="callback"></a></span></a></p>
<ul>
<li><p><a class="reference internal" href="#interruption-of-data-flow-a-name-interruption-of-data-flow-a" id="id2">Interruption of data flow <span class="raw-html-m2r"><a name="interruption-of-data-flow"></a></span></a></p></li>
<li><p><a class="reference internal" href="#saver-callback-a-name-saver-callback-a" id="id3">Saver callback <span class="raw-html-m2r"><a name="saver-callback"></a></span></a></p></li>
<li><p><a class="reference internal" href="#buffer-callback-a-name-buffer-callback-a" id="id4">Buffer callback <span class="raw-html-m2r"><a name="buffer-callback"></a></span></a></p></li>
<li><p><a class="reference internal" href="#callbacks-as-sessionrunhook-a-name-callback-training-a" id="id5">Callbacks as SessionRunHook <span class="raw-html-m2r"><a name="callback_training"></a></span></a></p></li>
<li><p><a class="reference internal" href="#kpievaluator-as-callback-a-name-kpi-callback-a" id="id6">KPIEvaluator as callback <span class="raw-html-m2r"><a name="kpi-callback"></a></span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#callbackshandler-a-name-callbacks-handler-a" id="id7">CallbacksHandler <span class="raw-html-m2r"><a name="callbacks-handler"></a></span></a></p></li>
<li><p><a class="reference internal" href="#trainer-a-name-trainer-a" id="id8">Trainer <span class="raw-html-m2r"><a name="trainer"></a></span></a></p>
<ul>
<li><p><a class="reference internal" href="#using-of-estimator-api-a-name-using-of-estimator-api-a" id="id9">Using of estimator API <span class="raw-html-m2r"><a name="using-of-estimator-API"></a></span></a></p></li>
<li><p><a class="reference internal" href="#export-of-the-model-a-name-model-export-a" id="id10">Export of the model <span class="raw-html-m2r"><a name="model-export"></a></span></a></p></li>
<li><p><a class="reference internal" href="#profiling-a-name-profiling-a" id="id11">Profiling <span class="raw-html-m2r"><a name="profiling"></a></span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#inferer-a-name-inferer-a" id="id12">Inferer <span class="raw-html-m2r"><a name="inferer"></a></span></a></p>
<ul>
<li><p><a class="reference internal" href="#tensorrt-support-a-name-tensorrt-support-a" id="id13">Tensorrt support <span class="raw-html-m2r"><a name="tensorrt-support"></a></span></a></p></li>
</ul>
</li>
</ul>
</div>
<p>Main task is to coordinate the process of training / inference.</p>
<div class="section" id="coordinatorcallback-a-name-callback-a">
<h2><a class="toc-backref" href="#id1">CoordinatorCallback <span class="raw-html-m2r"><a name="callback"></a></span></a><a class="headerlink" href="#coordinatorcallback-a-name-callback-a" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">CoordinatorCallback</span></code> is a particular <em>Nucleotide</em> with main task to execute
some functions after each coordinator iteration (can be training, evaluation,
inference), e.g. logging the training status, storing of predictions on hard
drive, postprocessing of predictions etc.</p>
<p>This class has same interface for all the modes.</p>
<p>Let’s look if you want to use it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nucleus7</span> <span class="k">as</span> <span class="nn">nc7</span>


<span class="k">class</span> <span class="nc">NewCoordinatorCallback</span><span class="p">(</span><span class="n">nc7</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">CoordinatorCallback</span><span class="p">):</span>
    <span class="c1"># these names must match kwargs from predict method:</span>
    <span class="n">incoming_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;image1&#39;</span><span class="p">,</span> <span class="s1">&#39;image2&#39;</span><span class="p">,</span> <span class="s1">&#39;_optional_input&#39;</span><span class="p">]</span>
    <span class="c1"># these names must match keys of the returned dict out of process method</span>
    <span class="n">generated_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;very_novel_output&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">on_iteration_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span>
        <span class="n">summary_writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_writer</span>
        <span class="n">summary_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_step</span>
        <span class="n">iteration_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_info</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>
        <span class="n">is_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span>
        <span class="n">number_iterations_per_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_iterations_per_epoch</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">on_iteration_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Following differences to main nucleotide class:</p>
<ul class="simple">
<li><p>process method is called <code class="docutils literal notranslate"><span class="pre">on_iteration_end</span></code>, but has same signature</p></li>
<li><p>it has following executive methods:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">begin</span></code> - is called without any arguments on the beginning of the run;
can be used to initialize some variables</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">end</span></code> - is called on run end, so can be used to finalize</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_iteration_start</span></code> - is called before every iteration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_iteration_end</span></code> - is called after every iteration and has the outputs
of iteration as input</p></li>
</ul>
</li>
<li><p>following internal attributes:</p>
<ul>
<li><p>log_dir - directory to save the results</p></li>
<li><p>summary_writer - to use if you want to save the results to summaries
(directory is different from log_dir, so use only this writer)</p></li>
<li><p>summary_step - step of the summaries - differ from global step, e.g.
has offset for evaluation mode</p></li>
<li><p>iteration_info - iteration info with following fields:</p>
<ul>
<li><p>epoch_number</p></li>
<li><p>iteration_number</p></li>
<li><p>execution_time - time of network execution</p></li>
<li><p>is_last_iteration - flag if this iteration is last one in the
inference (is all the time False for training)</p></li>
</ul>
</li>
<li><p>number_iterations_per_epoch - number of iterations per epoch</p></li>
</ul>
</li>
</ul>
<div class="section" id="interruption-of-data-flow-a-name-interruption-of-data-flow-a">
<h3><a class="toc-backref" href="#id2">Interruption of data flow <span class="raw-html-m2r"><a name="interruption-of-data-flow"></a></span></a><a class="headerlink" href="#interruption-of-data-flow-a-name-interruption-of-data-flow-a" title="Permalink to this headline">¶</a></h3>
<p>In some cases, callbacks may collect some data from multiple iterations and
pass only that collected data further, e.g. processing of sequences etc.
In all other cases, when data was not collected still, you don’t want to pass
data to next callbacks. To implement it, you can just return <code class="docutils literal notranslate"><span class="pre">None</span></code> inside of
your <code class="docutils literal notranslate"><span class="pre">on_iteration_end</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nucleus7</span> <span class="k">as</span> <span class="nn">nc7</span>

<span class="k">class</span> <span class="nc">CollectorCallback</span><span class="p">(</span><span class="n">nc7</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">CoordinatorCallback</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="n">collect_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">not_collected</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>This will pass the results only when data is collected and in other cases
all dependent callbacks will not be executed.</p>
</div>
<div class="section" id="saver-callback-a-name-saver-callback-a">
<h3><a class="toc-backref" href="#id3">Saver callback <span class="raw-html-m2r"><a name="saver-callback"></a></span></a><a class="headerlink" href="#saver-callback-a-name-saver-callback-a" title="Permalink to this headline">¶</a></h3>
<p>Saving mostly should be done on single samples and not on the batches. It is
introduced inside of the <code class="docutils literal notranslate"><span class="pre">SaverCallback</span></code> interface:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nucleus7</span> <span class="k">as</span> <span class="nn">nc7</span>

<span class="k">class</span> <span class="nc">NewSaverCallback</span><span class="p">(</span><span class="n">nc7</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">SaverCallback</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">save_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">sample_data</span><span class="p">):</span>
        <span class="n">save_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_name</span>
        <span class="c1"># save the data to save_name</span>
</pre></div>
</div>
<p>It uses method <code class="docutils literal notranslate"><span class="pre">split_batch_inputs</span></code> to split the inputs of batches, by first
flattering the result and then split it to samples and unflatten back. If some
of the inputs are not in batch-wise fashion, it is possible to set the flag
<code class="docutils literal notranslate"><span class="pre">not_batch_keys</span></code> to point to that keys.</p>
<p>One more important is that the save_name is abstracted away from the developer.
It is set on every sample as following:</p>
<ul class="simple">
<li><p>if save_names was provided as a key, it will use it and add to <code class="docutils literal notranslate"><span class="pre">self.log_dir</span></code>
together with save_prefix and suffix.</p></li>
<li><p>if it was not provided, then it will be inferred out of the epoch, iteration
and sample number.</p></li>
<li><p>to add the extension, you need to add it by your own.</p></li>
</ul>
<p>Also there is a class for saving the data to tfrecords format, e.g.
<code class="docutils literal notranslate"><span class="pre">TfRecordsSaverCallback</span></code>. It is a standalone and self-contained class, which
will save the data to tfrecords files, where features, e.g. shapes and dtypes
are inferred from input data. It can be used directly. Also it will split the
data to files up to max number of files or when save_name was changed (useful
for sequential data).</p>
</div>
<div class="section" id="buffer-callback-a-name-buffer-callback-a">
<h3><a class="toc-backref" href="#id4">Buffer callback <span class="raw-html-m2r"><a name="buffer-callback"></a></span></a><a class="headerlink" href="#buffer-callback-a-name-buffer-callback-a" title="Permalink to this headline">¶</a></h3>
<p>Sometimes it is a good idea to accumulate the results and then perform some
calculations on them. Therefore there is a <code class="docutils literal notranslate"><span class="pre">BufferCallback</span></code> interface:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nucleus7</span> <span class="k">as</span> <span class="nn">nc7</span>

<span class="k">class</span> <span class="nc">MyBufferCallback</span><span class="p">(</span><span class="n">nc7</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">BufferCallback</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">process_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">buffer_data</span><span class="p">):</span>
        <span class="c1"># process the buffer</span>
</pre></div>
</div>
<p>This interface splits the batch data to samples as described before and then
adds single sample to the buffer. When you pass <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> flag to the callback,
it will execute <code class="docutils literal notranslate"><span class="pre">process_buffer</span></code> method on the buffer and free it afterwards.
So buffer processing can be controlled from outside. It is possible to use
different buffer interfaces for it.</p>
<p>It can be useful to deal with sequence data or to collect the data statistics.</p>
</div>
<div class="section" id="callbacks-as-sessionrunhook-a-name-callback-training-a">
<h3><a class="toc-backref" href="#id5">Callbacks as SessionRunHook <span class="raw-html-m2r"><a name="callback_training"></a></span></a><a class="headerlink" href="#callbacks-as-sessionrunhook-a-name-callback-training-a" title="Permalink to this headline">¶</a></h3>
<p>Even if same callbacks can be used for all training, evaluation and inference,
there is a difference <em>under the hood</em>, how they are executed inside of
different coordinators: <em>Inferer</em> calls each callback explicitly after
each sess.run,
where <em>Trainer</em> hides these calls by providing converting callbacks to
<code class="docutils literal notranslate"><span class="pre">tf.train.SessionRunHook</span></code> and providing them to
<code class="docutils literal notranslate"><span class="pre">tf.train.MonitoredTrainingSession</span></code>.
This conversion is done by using of method <code class="docutils literal notranslate"><span class="pre">convert_callback_to_session_hook</span></code>.</p>
<p>There are also default <code class="docutils literal notranslate"><span class="pre">tf.train.SessionRunHook</span></code> defined for <em>Trainer</em>:</p>
<ul class="simple">
<li><p>SummarySaverHook - saves summaries to <em>train</em> or to <em>eval</em> logging directories
depending on the mode and aligned to number of proceeded samples</p></li>
<li><p>MetricUpdateHook - evaluates metrics ops (e.g. update_op that are not a part
of train / eval graphs per default, but are used inside of metrics)</p></li>
</ul>
<p>From user or developer point of view, you do not need to adapt callback
implementation for training and can use same on for both - training and
inference. Only difference is that inside of training you can use also
<code class="docutils literal notranslate"><span class="pre">self.summary_writer</span></code> (<code class="docutils literal notranslate"><span class="pre">tf.train.FileWriter</span></code>) to write your values to .event
files.</p>
</div>
<div class="section" id="kpievaluator-as-callback-a-name-kpi-callback-a">
<h3><a class="toc-backref" href="#id6">KPIEvaluator as callback <span class="raw-html-m2r"><a name="kpi-callback"></a></span></a><a class="headerlink" href="#kpievaluator-as-callback-a-name-kpi-callback-a" title="Permalink to this headline">¶</a></h3>
<p>You can also include the <code class="docutils literal notranslate"><span class="pre">KPIEvaluator</span></code> configs as a callback configs.
<strong>nucleus7</strong> will convert them to <code class="docutils literal notranslate"><span class="pre">KPIEvaluatorCallback</span></code> and so it will run
the evaluation as intended on every iteration. Even if you can include it for
both training and evaluation, it is encouraged to use it only as a evaluation
callback, since it may take lot of time and so will slow down the training.</p>
<p>Calculated KPIs will be automatically added to tensorfboard summaries and
will also be saved together with the exported model as evaluation results.</p>
</div>
</div>
<div class="section" id="callbackshandler-a-name-callbacks-handler-a">
<h2><a class="toc-backref" href="#id7">CallbacksHandler <span class="raw-html-m2r"><a name="callbacks-handler"></a></span></a><a class="headerlink" href="#callbackshandler-a-name-callbacks-handler-a" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">CallbacksHandler</span></code> takes care of execution of callbacks and first creates
a graph (DNA helix) of the callbacks and sorts them in topological order and
the calls it’s methods in the right order:</p>
<p><code class="docutils literal notranslate"><span class="pre">begin</span></code> &amp;rightarrow;
{<em>repeat</em> <code class="docutils literal notranslate"><span class="pre">on_iteration_start</span></code> &amp;rightarrow; <code class="docutils literal notranslate"><span class="pre">iteration</span></code> &amp;rightarrow;
<code class="docutils literal notranslate"><span class="pre">on_iteration_end</span></code>} &amp;rightarrow; <code class="docutils literal notranslate"><span class="pre">end</span></code></p>
</div>
<div class="section" id="trainer-a-name-trainer-a">
<h2><a class="toc-backref" href="#id8">Trainer <span class="raw-html-m2r"><a name="trainer"></a></span></a><a class="headerlink" href="#trainer-a-name-trainer-a" title="Permalink to this headline">¶</a></h2>
<p>As you can see from the name, <strong>Trainer</strong> is used to launch and coordinate
training / evaluation process and has following tasks:</p>
<ul class="simple">
<li><p>connect dataset to model and callbacks</p></li>
<li><p>create tensorflow graph for training, evaluation and inference</p></li>
<li><p>create checkpoints after every evaluation run</p></li>
<li><p>export model after every run</p></li>
</ul>
<div class="section" id="using-of-estimator-api-a-name-using-of-estimator-api-a">
<h3><a class="toc-backref" href="#id9">Using of estimator API <span class="raw-html-m2r"><a name="using-of-estimator-API"></a></span></a><a class="headerlink" href="#using-of-estimator-api-a-name-using-of-estimator-api-a" title="Permalink to this headline">¶</a></h3>
<p><strong>Trainer</strong> is using <code class="docutils literal notranslate"><span class="pre">tf.estimator.Estimator</span></code> API for training and evaluation.
It builds model_fn inside of <code class="docutils literal notranslate"><span class="pre">self.get_model_fn</span></code>using <em>ModelHandler</em>.
That allows to use directly same code for distributed and local
training / evaluation.</p>
<p>Evaluation is triggered once checkpoint is written. In local mode, session will
be closed and new one created with restored checkpoint on mode switch
(train -&gt; eval -&gt; train…). Summaries are written according to summary step
(global step with offset). Steps for training and evaluation are synchronized
in that way, that last step for evaluation and training in one epoch is the same
number and so evaluation step has initial offset of difference of iterations
for evaluation and training.</p>
</div>
<div class="section" id="export-of-the-model-a-name-model-export-a">
<h3><a class="toc-backref" href="#id10">Export of the model <span class="raw-html-m2r"><a name="model-export"></a></span></a><a class="headerlink" href="#export-of-the-model-a-name-model-export-a" title="Permalink to this headline">¶</a></h3>
<p>After every evaluation, the model is exported as following:</p>
<ul class="simple">
<li><p>using <a class="reference external" href="https://www.tensorflow.org/guide/saved_model#using_savedmodel_with_estimators">saved_model</a> model format under the
<code class="docutils literal notranslate"><span class="pre">project_dir/saved_models</span></code> directory together with:</p>
<ul>
<li><p>current losses</p></li>
<li><p>current KPI values</p></li>
<li><p>current global step</p></li>
</ul>
</li>
<li><p>using meta graph and checkpoints, which are saved to
<code class="docutils literal notranslate"><span class="pre">project_dir/checkpoints</span></code> directory (inference meta graph is saved only once)
together with names of input and output nodes</p></li>
</ul>
</div>
<div class="section" id="profiling-a-name-profiling-a">
<h3><a class="toc-backref" href="#id11">Profiling <span class="raw-html-m2r"><a name="profiling"></a></span></a><a class="headerlink" href="#profiling-a-name-profiling-a" title="Permalink to this headline">¶</a></h3>
<p>Sometimes it is needed to profile training. You can activate the
<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/train/ProfilerHook">ProfilerHook</a> inside of <code class="docutils literal notranslate"><span class="pre">trainer.json</span></code> by adding its
constructor attributes to following section (do not provide
output_dir!):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;run_config&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;profile_hook_config&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;save_steps&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
      <span class="nt">&quot;show_memory&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
      <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It will create <code class="docutils literal notranslate"><span class="pre">timeline-.json</span></code> file inside of project directory and you
can load it using Chrome.</p>
</div>
</div>
<div class="section" id="inferer-a-name-inferer-a">
<h2><a class="toc-backref" href="#id12">Inferer <span class="raw-html-m2r"><a name="inferer"></a></span></a><a class="headerlink" href="#inferer-a-name-inferer-a" title="Permalink to this headline">¶</a></h2>
<p>It is also pretty obvious, <strong>Inferer</strong> coordinates inference
process. And it uses <code class="docutils literal notranslate"><span class="pre">tf.contrib.predictor</span></code> API to make predictions.</p>
<p>There are some differences to <em>Trainer</em>:</p>
<ul class="simple">
<li><p><strong>Inferer</strong> does not build any tensorflow graph, but restores it from saved
model or meta graph and checkpoints</p></li>
<li><p>it uses only one GPU if available as for now</p></li>
<li><p>uses <em>DataFeeder</em> instead of <em>Dataset</em> to feed the data to placeholders</p></li>
<li><p><em>Callbacks</em> are executed explicitly</p></li>
<li><p>Can handle list of feed_dicts and perform one iteration for each feed_dict and
then collapse outputs before passing them to callbacks</p></li>
<li><p>if you want to store the results, you need to provide corresponding Callback</p></li>
</ul>
<p>By default, data prefetching, network itself and callbacks are running
in separate processes and communicate using queues. But if you want to
use single process, you can enable it by adding following in your
<code class="docutils literal notranslate"><span class="pre">inferer.json</span></code> config file:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;run_config&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;use_multiprocessing&quot;</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="tensorrt-support-a-name-tensorrt-support-a">
<h3><a class="toc-backref" href="#id13">Tensorrt support <span class="raw-html-m2r"><a name="tensorrt-support"></a></span></a><a class="headerlink" href="#tensorrt-support-a-name-tensorrt-support-a" title="Permalink to this headline">¶</a></h3>
<p>If you have installed tensorrt (<a class="reference external" href="Installation.html">see how</a>), you can enable it
during inference. In that case, it will create tensorrt graph out of
saved model and use it. To enable it, you can provide the following
config inside of <code class="docutils literal notranslate"><span class="pre">inferer.json</span></code>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;tensorrt_config&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;use_tensorrt&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;max_batch_size&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
    <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>or you can pass the <code class="docutils literal notranslate"><span class="pre">nc7.coordinator.configs.TensorrtConfig</span></code> to the
<code class="docutils literal notranslate"><span class="pre">Inferer</span></code> constructor.</p>
<p>To refer to parameters and what they mean, see tensorflow tensorrt
<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/16d7642c6481b703ab433596af27c2ef5141eb51/tensorflow/python/compiler/tensorrt/trt_convert.py">code</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Optimization.html" class="btn btn-neutral float-right" title="Optimization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Model.html" class="btn btn-neutral float-left" title="Model parts" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Audi Electronics Venture GmbH

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>